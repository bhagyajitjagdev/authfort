---
title: Server API
description: Complete AuthFort class method reference.
sidebar:
  order: 1
---

import CodeBlock from '../../../components/CodeBlock.astro';

export const constructor = `AuthFort(
    database_url: str,
    *,
    access_token_ttl: int = 900,
    refresh_token_ttl: int = 2592000,
    jwt_issuer: str = "authfort",
    cookie: CookieConfig | None = None,
    providers: list | None = None,
    key_rotation_ttl: int = 172800,
    introspect_secret: str | None = None,
    allow_signup: bool = True,
    password_reset_ttl: int = 3600,
    rsa_key_size: int = 2048,
    frontend_url: str | None = None,
)`;

export const hookDecorator = `@auth.on("login")
async def on_login(event):
    ...`;

export const getSessionExample = `async with auth.get_session() as session:
    ...`;

## Constructor

<CodeBlock code={constructor} lang="python" />

See [Configuration](/authfort/server/configuration/) for parameter details.

---

## Authentication

### `create_user(email, password, *, name=None, avatar_url=None, phone=None)`

Create a new user. Works regardless of `allow_signup` setting.

| Param | Type | Description |
|-------|------|-------------|
| `email` | `str` | User email (normalized) |
| `password` | `str` | Plain text password (hashed with argon2) |
| `name` | `str \| None` | Display name |
| `avatar_url` | `str \| None` | Profile image URL |
| `phone` | `str \| None` | Phone number |

**Returns:** `AuthResponse`
**Raises:** `AuthError` if email already exists

### `login(email, password)`

Authenticate with email and password.

**Returns:** `AuthResponse`
**Raises:** `AuthError` if credentials invalid or user banned

### `refresh(raw_refresh_token)`

Exchange a refresh token for new tokens.

**Returns:** `AuthResponse`
**Raises:** `AuthError` if token invalid, expired, or revoked

### `logout(raw_refresh_token)`

Revoke a refresh token.

**Returns:** `None`

---

## Password Management

### `create_password_reset_token(email)`

Generate a password reset token.

**Returns:** `str | None` — token string, or `None` if email not found / OAuth-only account

### `reset_password(token, new_password)`

Reset password using a reset token. Bumps token version and revokes all refresh tokens.

**Returns:** `bool` — `True` if successful, `False` if token invalid/expired

### `change_password(user_id, old_password, new_password)`

Change password for an authenticated user. Bumps token version and revokes all refresh tokens.

**Returns:** `None`
**Raises:** `AuthError` if old password is wrong

---

## Role Management

### `add_role(user_id, role, *, immediate=True)`

Assign a role to a user.

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `user_id` | `UUID` | — | User ID |
| `role` | `str` | — | Role name |
| `immediate` | `bool` | `True` | Bump token version to invalidate existing tokens |

**Returns:** `None`

### `remove_role(user_id, role, *, immediate=True)`

Remove a role from a user.

**Returns:** `None`

### `get_roles(user_id)`

Get all roles assigned to a user.

**Returns:** `list[str]`

### `has_role(user_id, role)`

Check if a user has a specific role.

| Param | Type | Description |
|-------|------|-------------|
| `user_id` | `UUID` | User ID |
| `role` | `str` | Role name |

**Returns:** `bool`

---

## User Management

### `ban_user(user_id)`

Ban a user. Sets banned flag, bumps token version, revokes all refresh tokens.

**Returns:** `None`

### `unban_user(user_id)`

Unban a user.

**Returns:** `None`

### `update_user(user_id, *, name, avatar_url, phone)`

Update a user's profile fields. Only provided fields are changed — omitted fields are left untouched. Pass `None` to clear a field.

| Param | Type | Description |
|-------|------|-------------|
| `user_id` | `UUID` | User ID |
| `name` | `str \| None` | Display name (omit to leave unchanged) |
| `avatar_url` | `str \| None` | Profile image URL (omit to leave unchanged) |
| `phone` | `str \| None` | Phone number (omit to leave unchanged) |

**Returns:** `UserResponse`
**Raises:** `AuthError` if user not found, or if no fields are provided

---

## Session Management

### `get_sessions(user_id, *, active_only=False)`

List sessions for a user.

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `user_id` | `UUID` | — | User ID |
| `active_only` | `bool` | `False` | Only return non-revoked, non-expired sessions |

**Returns:** `list[SessionResponse]`

### `revoke_session(session_id)`

Revoke a single session.

**Returns:** `bool` — `True` if found and revoked

### `revoke_all_sessions(user_id, *, exclude=None)`

Revoke all sessions for a user. Bumps token version.

| Param | Type | Default | Description |
|-------|------|---------|-------------|
| `user_id` | `UUID` | — | User ID |
| `exclude` | `UUID \| None` | `None` | Session ID to keep alive |

**Returns:** `None`

---

## Key Management

### `rotate_key()`

Create a new signing key and retire the current one.

**Returns:** `str` — new key ID (kid)

### `cleanup_expired_keys()`

Delete expired signing keys from the database.

**Returns:** `int` — number of keys deleted

### `cleanup_expired_tokens()`

Delete expired verification tokens (password reset tokens).

**Returns:** `int` — number of tokens deleted

### `cleanup_expired_sessions()`

Delete expired or revoked refresh tokens (sessions).

**Returns:** `int` — number of sessions deleted

### `get_jwks()`

Get the JWKS (JSON Web Key Set) as a dict. Returns the public signing keys in JWK format. Useful for serving JWKS from non-FastAPI frameworks (Django, Flask, etc.).

**Returns:** `dict` — JWKS document with `keys` array

---

## OAuth

### `get_provider_tokens(user_id, provider)`

Get the stored OAuth tokens for a provider account.

| Param | Type | Description |
|-------|------|-------------|
| `user_id` | `UUID` | User ID |
| `provider` | `str` | Provider name (`"google"` or `"github"`) |

**Returns:** `dict | None` — dict with `access_token`, `refresh_token`, and `expires_at` keys, or `None` if no account exists for this provider

---

## Event Hooks

### `on(event_name)`

Decorator to register an event hook.

<CodeBlock code={hookDecorator} lang="python" />

### `add_hook(event_name, callback)`

Programmatically register an event hook.

---

## Database

### `migrate()`

Run pending Alembic migrations. Idempotent — safe to call on every startup.

**Returns:** `None`

### `dispose()`

Dispose the database engine and connection pool.

**Returns:** `None`

### `get_session()`

Async context manager for database sessions (for non-FastAPI code).

<CodeBlock code={getSessionExample} lang="python" />

---

## FastAPI Integration

### `fastapi_router()`

Returns a FastAPI `APIRouter` with all auth endpoints (signup, login, logout, refresh, me, password reset, OAuth). Mount with `app.include_router(auth.fastapi_router(), prefix="/auth")`.

**Returns:** `APIRouter`

### `jwks_router()`

Returns a FastAPI `APIRouter` serving `/.well-known/jwks.json`. Mount separately: `app.include_router(auth.jwks_router())`.

**Returns:** `APIRouter`

### `current_user`

FastAPI dependency that extracts and verifies the JWT from the request. Returns a `UserResponse`.

```python
@app.get("/profile")
async def profile(user: UserResponse = Depends(auth.current_user)):
    return user
```

### `require_role(role)`

FastAPI dependency factory that checks if the authenticated user has a specific role (or any of a list of roles).

| Param | Type | Description |
|-------|------|-------------|
| `role` | `str \| list[str]` | Required role(s) — user must have at least one |

```python
@app.get("/admin")
async def admin(user=Depends(auth.require_role("admin"))):
    ...
```

See [FastAPI Integration](/authfort/server/fastapi/) for full usage guide.

---

## Properties

| Property | Type | Description |
|----------|------|-------------|
| `config` | `AuthFortConfig` | Read-only access to configuration |
| `session_factory` | `async_sessionmaker` | The async session factory |
| `hooks` | `HookRegistry` | The event hook registry |
